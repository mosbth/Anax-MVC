# Rapporter

## Kmom05

Jag valde att göra en "Contact form"-modul med inspiration från två WordPress plugins [Contact Form 7](https://wordpress.org/plugins/contact-form-7/) och [Flamingo](https://wordpress.org/plugins/flamingo/). Med CF7 kan man skapa flexibla formulär och få formulärdatat skickat till en email-mottagare. Flamingo lägger till möjligheten att spara meddelanden från CF7 till lokal databas utöver att mail skickas iväg, samt lagrar även kontaktuppgifter lokalt i databas för alla som via CF7 submittar namn, email etc. Normalt brukar "Contact form" plugins enbart skicka vidare meddelandet via mail. En risk med detta är att mailet kan försvinna i spam-filter hos mottagern alternativt att webbservern får problem att skicka iväg mailet. Meddelandet går då förlorat. En lösning är då att spara meddelandet lokalt på servern i en databas. Min modul är en väldigt förenklad variant av detta. Användaren kan lägga till en vy mha dispatcher för att visa kontaktformuläret  på valfri sida. För att visa och adminstrera meddelandena behöver användaren lägga till en annan via mha dispatcher på en lämplig route. Denna route bör enbart göras åtkomlig för webb-adminstratören.

"Contact Form"-modulen är baserad på och lik Comment-modulen jag tog fram i Kmom04. Funktionen är dock annorlunda och fyller ett specifikt behov. Jag började med att bygga upp modulen i ett sub-repo under Anax-MVC/vendor. Efter lite felsökning, förmodligen problem med autoloader, så flyttade jag ut sub-repot utanför Anax-MVC. Istället testade jag ut funktionalitet med modulen under Anax-MVC/src.

När det väl funkade under /src, flyttade jag in filerna till ett "Contactform"-repo utanför Anax-MVC, i rätt mapp-struktur, ändrade namespace, och skapade en autoloader-fil. Sedan var det "bara"  att koppla ihop så att repot pushades till github,  contactform-modulen hämtades från git till packagist, och sist från packagist ner till vendor-mappeni Anax-MVC. Efter några småjusteringar i koden så funkade det igen. Detta gick över förväntan smidigt. Efter att jag fick ner contactform-modulen till vendor-mappen kunde jag återigen jobba i denna mappen som ett sub-repo för contactform.

Standardinstallation av Anax MVC har jag valt att definiera såsom min version av [Anax-MVC v.04 kmom04](https://github.com/fnlive/Anax-MVC/releases/tag/v0.4), dvs Anax-MVC från föregående moment. Utöver de beroenden som jag listat i installatins-anvisning på github/packagist så behövs även Anax-MVC/src/MVC/CDatabaseModel.php, som finns just i denna version av Anax-MVC.

Jag prövade installation från scratch genom att följa min [instruktion](https://github.com/fnlive/contactform#installation), ladda ner [Anax-MVC v.04 kmom04](https://github.com/fnlive/Anax-MVC/releases/tag/v0.4), uppdatera composer-fil, köra composer-update, kopiera template-filer, testa test-fil i webbläsaren. Det funkade såklart inte direkt utan jag fick göra små modifieringar både i instruktion och  testContactform.php några gånger för att få allt på plats. Blir lätt omständligt för att uppdatera hela vägen med git add/commit/push, update i packagist, och sedan composer update, för varje lite ändring man vill testa. Det skall gå att få till automatisk uppdatering av Packagist när github uppdateras, men jag har inte lyckats aktivera detta.  

Kopieringen av template-filer känns lite onödig. Det kanske skulle gå att peka ut dessa på dess ursprungliga ställe.

Jag har även integrerat contactform-modulen i denna Anax-installation. Exempel på kontaktformuläret kan man hitta under meny-valet [Tärning](dice). Adminstration av meddelanden kan man göra under meny-valet [Admin/Meddelanden](admincontacts). Insikt i struktur och funktion i Anax-MVC har ytterligare fördjupats med denna uppgift. Jag navigerar runt i koden lite mer självsäkert nu.

Jag gjorde ingen extrauppgift.

## Kmom04

Generellt var detta en omfattande och tung uppgift. Jag slogs med många relativt enkla fel som tog tid att hitta. T.ex. funkade redirectTo() fint i UsersController men inte i CommentController. Missat att lägga med "use 'namespace'". Fick även läsa på igen om sql-syntax och installera [SQLite Manager](https://addons.mozilla.org/en-US/firefox/addon/sqlite-manager/) för att pröva ut queries i en kontrollerad miljö. Etc. Har definitivt utökat debugging erfarenheter i denna uppgift.

Övningen "databasklassen som en tjänst" och med att lägga upp databasmodell, för en generisk och en specialiserad för användare, var väldigt nyttig. Den generiska modellen fungerande väldigt bra för att även bygga vidare på med en specialiserad modell för kommentarer. Jag fick justera vissa metoder och omdefiniera dem. T.ex. findAll() metoden gjorde bara halva jobbet med att hämta ut data. Vissa data behövde däremot räknas ut on-the-fly (gravatar-länk och since-time). Löstes genom att överlagra findAll() i CommentsInDb som ärver från CDatabaseModel och där först anropa parent:findAll för att göra grundjobbet och sedan resten resten av datat som behövde läggas till.

Formulärhantering med CForm var betydligt smidigare än att manuellt lägga upp html-formulär och sedan försöka fånga det submittade datat. Jag satte saveInSession till false då jag annars fick gammalt ifyllt formulär-data i nytt formulär. Aktivering och soft-radering löste jag med 4 olika routes i UsersController. Ett annat kanske bättre alternativ hade varit att lägga till två radio-knapps-element för detta i update-formuläret. Hade blivit lite mindre kod och mer överskådligt för användaren. De flesta länkar i listan över users hade då försvunnit.

Modellen för kommentarer, CommentsInDb, kunde ärva basmodellen CDatabaseModel, med tillägg av init-funktion för population av test-data, sökfunktion findFlow() för att hitta kommentarer för visst flöde, hjälpfunktioner för gravatars och since-time, samt överlagring av metoden findAll(). Varje kommentar är kopplad till ett kommentarsflöde (flow) som är samma sak som route för den sidan som kommentaren skapades på. Routen skickas med som parameter för respektive action som behöver veta flow, t.ex. (webroot)/comment/add/commentadmin/lorem. Route till sidan som användaren vill kommentera blir då commentadmin/lorem. Denna route skapar två argument till funktionen "add" i controllern "comment". Argumenten klistras återigen ihop i funktionen add() mha implode() till route/flow. Route/flow sparas ihop med kommentar för att tagga kommentaren samt används efter sparning till databas för att göra redirect tillbaks till sidan där kommentaren lämnades. Det blev också väldigt smidigt att lägga till kommentars-kontrollern som en vy på en sida/route som innehåller både visning av kommentarer och länk för att skriva ny kommentar.

Viss rudimentär felhantering är inlagd i Comments- och UsersController, t.ex. om en viss kommentars-id eller users-id finns vid redigering av post, eller kontroll om användaren vill redigera acronym och spara tillbaks post med acronym som redan finns definierad för annan användare.

Användare administreras från [Användare](users). Kommentarer  administreras från [Kommentarer](commentadmin) där alla kommentarer kan visas oavset flow/route. Kommentarer finns demonstrerade på sidorna [Kalender](calendar) och [commentadmin/lorem](commentadmin/lorem).

Jag har inte gjort några av extrauppgifterna.

## Kmom03

Jag har inte arbetat med några CSS-ramverk tidigare, så det var ett väldigt nyttigt kursmoment. Det var ett ganska omfattande material att läsa in med mycket nya begrepp. LESS kändes väldigt enkelt att komma igång med. Det löser många problem jag känt vid arbete med CSS, t.ex. att kunna definiera variabler för att enkelt ändra en färg som används på flera ställen, mixins för att enkelt kunna återanvända definitioner. lessphp var ett smidigt sätt för att komma igång med LESS. En nackdel är att firebug inte direkt visar definitionerna från less-filerna utan man får försöka tolka vilken LESS-konstruktion som skapat vilken css-konstruktion. Skriver man fel LESS-syntax är det inte heller helt lätt att förstå vad som är fel var nånstans. När jag skapade filen variables.less glömde jag ta bort motsvarande definition av @total-width i grid.less. Det tog en del tid att förstå varför när jag inte fick fluid layout att fungera.

Semantic.gs var enkelt att få igång för att få till en robust layout och enkelt att få den responsiv. När jag ville styla mina olika sektioner i layout genom att lägga till borders och padding fick jag lite problem. Sektionen tog då större bredd och puttade ner sektioner som skulle ligga till höger. För att lösa det skapade jag en ".cont"-div inuti varje layout-sektion. Denna ".cont"-div kunde jag då styla och ändå få rätt bredd på omslutande sektion.

Font Awesome kikade jag lite på i förra uppgiften kmom02. Enkelt sätt att få in många olika grafiska ikoner på ett enkelt sätt. Något jag funderade på är hur accessibility, "a11y", påverkas. Jag löste det i kmom02 genom att lägga till text för ikonen med en klass .screen-reader-text som döljer texten. Normalize verkar vara en bra metod få till ett känt utgångsläge för att börja styla ett tema. Bootstrap har jag inte tittat så djupt in i. Det verkar innehålla mycket användbart alltifrån "grid system" till stylade html-element som rubriker, formulär och knappar.

Jag har gett några sidor olika utseende baserat på route. I body-elementet lägger jag till ett id döpt efter route och använder detta i min less-fil för styling av individuella sidor. På [about-](about) och [redovisnings-sidan](redovisning) har sneglat lite på koncept  från ["Google material design"](https://www.google.com/design/spec/material-design/introduction.html) där varje sektion i grid-systemet blir ett ark som ligger upphöjt ovanför bottenplanet. På sidan "regioner/typography" har jag tittat på webbplatsen [New York Times](http://www.nytimes.com/) där sektioner i rutnätet avdelas med en tunn linje. För att få fram bild över rutsystemet går det att lägga till query-variabel [?show-grid=1](?show-grid=1) efter varje route. Då jag valt att ha en border och padding på innehåll så hamnar inte rad-start på grid-systemet utan 22+1 pixlar in från kolumn-start.

Det blir många valideringsfel från font-awesome och från lessphp's genererade css-fil. Enligt "Font awesom" beror det på medvetna browser-hacks för att kunna stödja gamla browser-versioner. Även less.inc.php genererade många lint-varningar som jag stängde av med direktivet @codingStandardsIgnoreStart. I övrigt bör html och less/css validera OK.

Denna gång gav jag mig inte på någon av extrauppgifterna. Huvuduppgiften gav en tillräcklig utmaning.

## Kmom02

Den här uppgiften kändes väldigt svår i början men det lossnade allteftersom pusselbitarna föll på plats och jag fick lite bättre översikt på ramverket. Första stora problemet var att förstå hur redirect efter sparande av kommentar skulle fungera och hur värden för redirect-sidan överfördes mellan de olika komponenterna. Spara-kommentar-formuläret postar ett gömt fält som skall innehålla redirect-sidan. Denna hämtas mha getPost i controller-sidan som då kan göra redirect efter att kommentaren sparats. Till att börja med hämtade jag redirect-sidan med getCurrentUrl() i form.tpl.php men flyttade sedan ut det till front-controller index.php och skickar istället in redirect-sidan via variabel för att hålla borta php-kod från template-sidorna.

Nästa större svårighet var att förstå hur dispatcher i förhållande till view skulle fungera. Med en dispatcher kan man flytta ut mer kontroll-logik från front-controller till i detta fall CommentController. Denna CommentController skapar och lägger till en vy i den route den blivit dispatchad från istället för att skapa vyn i front-controller. Vyn skapas med hjälp av modellen som ligger i CommentsInSession.

Jag har lagt ett kommentarsflöde under sidan [Kalender](calendar) och ett annat flöde under sidan [Kommentera](comment-2). Jag har valt att använda ikoner från Font Awesome för kommentars-funktionerna redigera och radera samt för webplats- och mail-adress. Validotorn hos Unicorn gillar dock inte deras css. Enligt [Font Awesome](https://fortawesome.github.io/Font-Awesome/get-started/) så innehåller de ett antal CSS browser hacks för att fungera med gamla browser-versioner som inte validatorn gillar. Hoppas det därför är OK med dessa validator-fel.

Det fungerade smidigt att arbeta med composer efter att jag fått det installerat. Jag fick inte igång det när jag hämtade hem det via php utan installerade det via en windows-installer.

Då jag behövde lägga till funktionalitet i de två Comment-klasserna under vendor, valde jag att skapa subklasser till dessa som jag lade under app/src/Comment. Jag håller då isär mina ändringar från ursprungsklasserna och kan uppdatera via Composer för eventuella bugg-rättningar. Mina sub-klasser har samma namn som bas-klasserna så här fick jag chans att lära mig mer om namespace för att hålla isär dem.

Jag browsade runt på Packagist webbplats och hittade en hel del paket som skulle kunna vara intressanta, t.ex. modul för markdown, modul för mail-service, google api-client, blogg för phalcon, rss-feeds, etc. Den stora tröskeln för att använda en modul är nog svårigheten att veta hur mycket arbete det är att integrera en modul, samt kvaliteten på modulen. Antalet nedladdningar och stjärnmärkningar kan kanske kan ge lite vägledning om kvalitet och användbarheten.

Den uppenbara förbättringen var att lägga till stöd för olika kommentars-flöden. Här valde jag att använda mig av kommentars-sidans route som tag för flödet. Denna tag lagras i varje kommentar. Till att börja med lade jag tag-filtreringen i template-filen men fick sedan flyttat filtreringen till CommentsInSession.php. Verkade vettigt då det mer hänger ihop med modelleringen av kommentarer och flödet. Även funktioner för att uppdatera och radera kommentarer har lagts till.

En egen liten förbättringen var att lägga till funktion för att omvandla unix tidsstämpel till en relativ tid, typ "postad för 3 minueter sedan." Hittade en funktion för detta på StackExhange som passade in bra. Då tiden är relativ måste den genereras varje gång en kommentar hämtas från CommentsInSession.

För extrauppgiften att dölja kommentarsformuläret och få fram det genom att klicka på en länk så började jag  att försöka lösa det mha två olika routes: en route som **utan** vyn med kommentarsformuläret samt en route **med** vyn för kommentarsformuläret. Enkel lösning men kändes lite klumpigt att upprepa två nästan identiska routes. Istället använde jag mig av en query-variabel i url'en för att visa formuläret. Är variabeln 'showform' satt så visas formuläret. Annars döljs formuläret mha css display:none. En ännu smidigare och enklare lösning vore att använda js/jquery med .show()/.hide()/.toggle() på något sätt. Men det kommer nog i nästa kurs.

Att lägga till gravatarer gick smidigt. I modellen för kommentarer, CommentsInSession/findAll(), beräknas gravatar-url och läggs till i array för kommentar. Url'en kan sedan läsas ut i vyn för kommentarer i comments.tpl.php.

## Kmom01

Min utvecklingsmiljö består av Windows 10 eller 7 med xampp, cygwin och atom texteditor. Under oophp-kursen började jag använda git och github som jag börjar få lite grepp om, så detta hade jag tänkt fortsätta med. Repona lägger jag på dropbox med mjuka länkar från webbservern. Jag skall också försöka få igång lintning i min lokala miljö. Windows 10 är nytt för mig sedan någon vecka tillbaks men verkar fungera OK än så länge.  

Jag har inte arbetat med några ramverk tidigare. Om man möjligen räknar WordPress som ett ramverk så har jag viss erfarenhet av att göra små förändringar i funktion och utseende. Där har jag skapat några enkla plugins för att bygga ut funktionalitet samt skapat "child themes" för att ändra utseende på ett grund-tema.

Jag är inte direkt bekant med de olika begreppen runt ramverk, mönster och arkitektur mer än möjligen att jag hört namen. MVC t.ex. är ju ett välkänt namn, så det ska bli kul att se hur det kan användas.

Under denna uppgift har jag lagt in 3 relativt enkla sidor, "Om mig", "Rapport", och "Source", samt 2 extra sidor: "Kasta tärning" och "Kalender". När jag väl förstått vilka delar som behöver uppdateras var nånstans, så har arbetet för att göra själva sidorna gått snabbt och varit rättframt. Det är relativt enkelt att använda de olika tjänsterna i ramverket såsom lägga till stylesheets, skapa "snygga" länkar, filtrera markdown-text till html etc. Strukturen i ramverket uppmuntrar till bättre uppdelning av koden. T.ex. tog jag min kalender-funktion från oophp och anpassade till Anax-MVC. Det första jag fick göra var att dra ur modellen av kalendern och lägga den i app/src/CCalender, samt presentationen/vyn och lägga den i app/view/calender. För att kunna skicka rätt data till app/view/calender, anropar controllern index.php metoderna i CCalender och skickar vidare datat till kalender-vyn via ramverket. Detta känns bra, enkelt och snyggt.

Det verkar lite avigt att filerna för en app ligger utspridda i många olika mappar. Det hade känts smidigare om alla filer för en app/sida låg i en gemensam mapp. T.ex för kalendern så ligger controller-delen i weebroot/index.php, stylesheets under webroot/css, vyn ligger under app/view/calendar, modellen av kalendern ligger under app/src/Calendar samt meny-element läggs in i app/config/navbar_me.php. Det hade kännts smidigare om allt hade kunnat samlas inom en mapp som låg under mappen app/ men med en uppdelning i specifika filer t.ex. vy-, modell-, style-filer, etc.. T.ex. installation av en ny app blir enklare om den är sammanhållen med alla delar som behövs i en mapp.

Filen index.php börjar redan nu bli ganska stor och innehåller flera olika funktioner/appar. Förmodligen finns det ett sätt att ha en tunn index.php som ropar in dedicerade controller-filer efter behov.
